#install.packages("tm") 
#install.packages("libxml2") 
#install.packages("corpustools") 
#install.packages("mongolite") 
#install.packages("dplyr") 
#install.packages("fastrtext") 

library(mongolite)
library(dplyr) 
library(tm)
library(corpustools)
library(fastrtext)

# Remove Variables if they exist
if (exists("m")) {rm(m)}
if (exists("getdata")) {rm(getdata)}
if (exists("listid")) {rm(listid)}
if (exists("listtext")) {rm(listtext)}
if (exists("textframe")) {rm(textframe)}
if (exists("corpus")) {rm(corpus)}
if (exists("corpus")) {rm(corpusmatrix)}

# Verbindung zu Kategorien, wird aktuell nicht gebraucht
# m <- mongo("categories", url = "mongodb://192.168.2.135:27017/mails")  

# Verbindung zur MongoDB zu den Mails:
m <- mongo("interactions", url = "mongodb://192.168.2.135:27017/mails")  
getdata <- m

# Durchzählen wie viele Datensätze vorhanden sind
getdata$count('{}')

# Abfrage der IDs und abspeichern, mit Limit kann die Anzahl begrenzt werden
listid <- getdata$find(
  query = '{}', 
  fields = '{"categories.id" : true, "_id": false}'
 # ,limit = 5
)

# Abfrage der Texte (nur relevanter Text) und abspeichern
listtext <- getdata$find(
  query = '{}', 
  fields = '{"categories.text" : true, "_id": false}'
 # ,limit = 5
)


# Dataframes zusammenführen und anpassen
textframe <- data.frame(listid, listtext)
colnames(textframe) <- c("id", "text")
print(textframe)


# wir Laden die 2te Spalte in den Dataframe und verwenden tm zur Breinigung
corpus <- VCorpus(VectorSource(textframe[,2]))

# inspect(corpus)
#whitespace entfernen
corpus <- tm_map(corpus, stripWhitespace)
#convert to lowercases
corpus <- tm_map(corpus, content_transformer(tolower))
#remove stopwords
corpus <- tm_map(corpus, removeWords, stopwords("german"))
#stemming
tm_map(corpus, stemDocument)

#Term document Matrices
corpusmatrix <- DocumentTermMatrix(corpus)
inspect(corpusmatrix)

#Häufigkeitsmatrix
findFreqTerms(corpusmatrix, 10)

#Korrelationen zwischen einzelnen Wörtern
findAssocs(corpusmatrix, "fehler", 0.5)

#wir entfernen sehr seltene wörter, die unwichtig bzgl. der korrelation sind
removeSparseTerms(corpusmatrix, 0.4)
inspect(corpusmatrix)


#FASTRTEXT
data("train_sentences")
texts <- tolower(train_sentences[,"text"])

tmp_file_txt <- tempfile()
tmp_file_model <- tempfile()
writeLines(text = texts, con = tmp_file_txt)
